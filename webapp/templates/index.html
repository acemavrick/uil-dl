<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIL-DL 1.0 Beta</title>
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/out.css') }}">
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-emerald-700 dark:text-emerald-300">
                UIL-DL 1.0 Beta
            </h1>
        </header>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- Left sidebar with filters -->
            <div class="md:w-1/4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                    <!-- Notes -->
                    <div class="mb-4 py-3 rounded-md border-b border-gray-200 dark:border-gray-700">
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            <span class="font-bold">Info Version: </span> {{ info_version }}
                            <br>
                            <span class="font-bold">Total Contests: </span> {{ total_contest_count }} 
                            <br>
                            <br>
                            <span class="font-bold">Your downloads are stored in:</span>
                            <br>
                            <code class="block p-2 mt-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono text-gray-800 dark:text-gray-200 overflow-x-auto">{{ download_dir_absolute }}</code>
                        <div class="mt-4">
                            <div class="flex flex-wrap gap-2">
                                <button 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md text-sm transition-colors duration-200 flex items-center justify-center"
                                    id="refresh-info-btn"
                                    hx-post="/refresh-info"
                                    hx-swap="none"
                                    hx-indicator="#refresh-info-btn .spinner-small"
                                    hx-disabled-elt="this">
                                    <span class="button-text mr-2">Refresh Info</span>
                                    <div class="spinner-small htmx-indicator"></div>
                                </button>
                                <button 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md text-sm transition-colors duration-200 flex items-center justify-center"
                                    id="select-path-btn"
                                    onclick="checkActiveDownloadsAndSetPath()"
                                    >
                                    <span class="button-text">Set Path</span>
                                </button>
                            </div>
                            <div class="mt-2">
                                <button 
                                    class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md text-sm transition-colors duration-200 flex items-center justify-center"
                                    id="shutdown-btn"
                                    hx-post="/shutdown"
                                    hx-swap="none">
                                    <span class="button-text">Shutdown</span>
                                </button>
                            </div>
                        </div>
                        </p>
                    </div>

                    <h2 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-200">Filters</h2>
                    
                    <!-- Filter Form -->
                    <form id="filter-form" 
                          hx-post="/contests" 
                          hx-target="#table-container" 
                          hx-trigger="change, submit"
                          hx-indicator="#loading-indicator">
                        
                        <div id="filter-tags" class="flex flex-wrap gap-2 mb-4"></div>
                        
                        <div class="space-y-5">
                            <!-- Subject filter -->
                            <div class="filter-group">
                                <details class="mb-2">
                                    <summary class="cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-200 mb-2 select-none">Subject</summary>
                                    <div class="pl-4 pt-2 space-y-1 max-h-48 overflow-y-auto">
                                        {% for subject in subjects %}
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="subjects" value="{{ subject }}" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                            <span class="text-sm text-gray-700 dark:text-gray-200">{{ subject }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </details>
                            </div>
                            
                            <!-- Level filter -->
                            <div class="filter-group">
                                <details class="mb-2">
                                    <summary class="cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-200 mb-2 select-none">Level</summary>
                                    <div class="pl-4 pt-2 space-y-1 max-h-48 overflow-y-auto">
                                        {% for level in levels %}
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="levels" value="{{ level }}" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                            <span class="text-sm text-gray-700 dark:text-gray-200">{{ level }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </details>
                            </div>
                            
                            <!-- Year filter -->
                            <div class="filter-group">
                                <details class="mb-2">
                                    <summary class="cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-200 mb-2 select-none">Year</summary>
                                    <div class="pl-4 pt-2 space-y-1 max-h-48 overflow-y-auto">
                                        {% for year in years %}
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="years" value="{{ year }}" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                            <span class="text-sm text-gray-700 dark:text-gray-200">{{ year }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </details>
                            </div>
                            
                            <!-- Status filter -->
                            <div>
                                <label for="downloaded-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Status</label>
                                <select name="downloaded" id="downloaded-filter" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 px-3 py-2">
                                    <option value="">All Status</option>
                                    <option value="true">Downloaded</option>
                                    <option value="partial">Partially Downloaded</option>
                                    <option value="false">Not Downloaded</option>
                                </select>
                            </div>
                            
                            <!-- Hidden sort fields -->
                            <input type="hidden" name="sort_by" value="year">
                            <input type="hidden" name="sort_dir" value="desc">
                        </div>
                    </form>
                    
                    <!-- Cache Information -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4" id="cache-info">
                        <h3 class="text-md font-medium mb-2 text-gray-700 dark:text-gray-200">Cache Information</h3>
                        <div hx-get="/cache-stats" hx-trigger="load" hx-target="this" hx-swap="innerHTML">
                            <div class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
                                <p>Downloaded Files: <span>{{ cache_stats.total_files|default(0) }}</span></p>
                                <p>Total Size: <span>{{ cache_stats.total_size|default(0)|filesizeformat }}</span></p>
                            </div>
                        </div>
                        
                        <!-- Cache Control Buttons -->
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <button hx-post="/refresh-cache" 
                                    hx-target="#cache-info div"
                                    class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:bg-blue-700 dark:hover:bg-blue-600">
                                Reload Cache
                            </button>
                            <button hx-post="/reset-cache" 
                                    hx-target="#cache-info div" 
                                    hx-confirm="Are you sure you want to reset the cache? This will forget all downloaded files (but won't delete the actual files)."
                                    class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:bg-red-700 dark:hover:bg-red-600">
                                Reset Cache
                            </button>
                        </div>
                    </div>

                    <!-- credits -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                        <div class="text-sm text-gray-600 dark:text-gray-300">
                            <p class="mb-1">Built by 
                                <a href="https://github.com/acemavrick" target="_blank" rel="noopener noreferrer" class="text-emerald-700 dark:text-emerald-300 hover:underline">acemavrick</a>
                            </p>
                            <p class="mb-1">Join the  
                                <a href="https://discord.gg/a6DdBaebPk" target="_blank" rel="noopener noreferrer" class="text-emerald-700 dark:text-emerald-300 hover:underline">Discord server</a>
                                for support, feedback, and updates.
                            </p>
                            <p>
                                <a href="https://github.com/acemavrick/uil-dl/tree/standalone" target="_blank" rel="noopener noreferrer" class="text-emerald-700 dark:text-emerald-300 hover:underline">Source on GitHub</a>
                            </p>
                            <p>
                                For more information (such as usage details), see the 
                                <a href="https://github.com/acemavrick/uil-dl/blob/standalone/README.md" target="_blank" rel="noopener noreferrer" class="text-emerald-700 dark:text-emerald-300 hover:underline">README</a>
                                on GitHub.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main content area -->
            <div class="md:w-3/4">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <div class="mb-4 flex justify-end items-center">
                        <div>
                            <button id="download-selected" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Download Selected
                            </button>
                        </div>
                    </div>

                    {% if error %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 dark:bg-red-900 dark:border-red-700 dark:text-red-100" role="alert">
                        <p>{{ error }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="overflow-x-auto relative">
                        <div id="loading-indicator" class="htmx-indicator absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10">
                            <div class="flex items-center">
                                <div class="spinner mr-2"></div>
                                <span>Loading...</span>
                            </div>
                        </div>
                        <div id="table-container"
                             hx-get="/contests"
                             hx-trigger="load"
                             hx-target="this"
                             hx-swap="innerHTML"
                             hx-include="#filter-form">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-300">Loading…</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top-color: #10b981;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        
        .spinner-small {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            width: 0.8rem;
            height: 0.8rem;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @media (prefers-color-scheme: dark) {
            .spinner {
                border: 2px solid rgba(255, 255, 255, 0.1);
                border-top-color: #10b981;
            }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .htmx-indicator {
            display: none;
        }
        
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        
        .status-badge {
            @apply px-2 py-1 text-xs font-medium rounded-full;
        }
        
        .status-downloaded {
            @apply bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100;
        }
        
        .status-partial {
            @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100;
        }
        
        .status-pending {
            @apply bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100;
        }
        
        .sortable:hover {
            @apply bg-gray-100 dark:bg-gray-600;
        }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const refreshInfoBtn = document.getElementById('refresh-info-btn');
        if (refreshInfoBtn) {
            const buttonText = refreshInfoBtn.querySelector('.button-text');

            refreshInfoBtn.addEventListener('htmx:beforeRequest', function() {
                if (buttonText) buttonText.textContent = '...';
            });

            refreshInfoBtn.addEventListener('htmx:afterRequest', function(event) {
                if (buttonText) buttonText.textContent = 'Refresh Info';

                if (event.detail.successful) {
                    alert('Success: ' + event.detail.xhr.responseText);
                    location.reload();
                } else {
                    alert('Error: ' + (event.detail.xhr.responseText || 'An unknown error occurred.'));
                    location.reload();
                }
            });
        }
    });

    // Function to check for active downloads before setting path
    async function checkActiveDownloadsAndSetPath() {
        try {
            const response = await fetch('/api/active-downloads');
            const data = await response.json();
            
            if (data.has_active) {
                const message = `You have ${data.active_count} download${data.active_count > 1 ? 's' : ''} currently in progress.\n\nChanging the download path will not cancel these downloads, but new downloads will go to the new location.\n\nDo you want to continue and set a new download path?`;
                
                if (confirm(message)) {
                    window.location.href = '/set-path';
                }
                // If user clicks "Cancel", do nothing (stay on current page)
            } else {
                // No active downloads, proceed directly
                window.location.href = '/set-path';
            }
        } catch (error) {
            console.error('Error checking active downloads:', error);
            // On error, ask user if they want to proceed anyway
            if (confirm('Unable to check for active downloads. Do you want to continue setting the path anyway?')) {
                window.location.href = '/set-path';
            }
        }
    }
    </script>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html> 